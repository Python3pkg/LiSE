# This file is part of LiSE, a framework for life simulation games.
# Copyright (c) 2013-2014 Zachary Spector,  zacharyspector@gmail.com
#: import StiffScrollEffect kivy.garden.stiffscroll.StiffScrollEffect
<Spot>:
    engine: self.board.layout.app.engine
    selected: self.board.layout.selected is self
<Pawn>:
    engine: self.board.layout.app.engine
    selected: self.board.layout.selected is self
<ArrowWidget>:
    engine: self.board.layout.app.engine if self.board and self.board.layout else None
    selected: self.board.layout.selected is self if self.board and self.board.layout else False
    canvas:
        Color:
            id: bg_color
            rgba: root.board.arrow_bg if root.board else [0,0,0,0]
        Line:
            id: bg_line
            width: root.w * 1.4
            points: root.points
        Color:
            id: fg_color
            rgba: root.board.arrow_fg if root.board else [0,0,0,0]
        Line:
            id: fg_line
            width: root.w
            points: root.points
<Arrow>:
    origin: self.board.spot[self.portal['origin']]
    destination: self.board.spot[self.portal['destination']]
<Dummy>:
    name: "".join((self.prefix, str(self.num)))
<ELiDELayout>:
    engine: self.app.engine
    board: board
    dummies: [dummything, dummyplace]
    ScrollView:
        effect_cls: StiffScrollEffect
        id: boardview
        size_hint: (0.85, 0.9)
        pos_hint: {'left': 0, 'top': 1}
        Board:
            id: board
            layout: root
            app: root.app
            engine: root.app.engine
            character: root.app.engine.character[root.app.config['ELiDE']['boardchar']]
            arrowlayout: arrowlayout
            spotlayout: spotlayout
            pawnlayout: pawnlayout
            size_hint: (None, None)
            size: wallpaper.size
            arrow_bg: (0.5, 0.5, 0.5, 0.5)
            arrow_fg: (1.0, 1.0, 1.0, 1.0)
            arrowhead_size: 10
            Image:
                id: wallpaper
                source: root.app.config['ELiDE']['wallpaper']
                size_hint: (None, None)
                size: self.texture_size
            FloatLayout:
                id: arrowlayout
            FloatLayout:
                id: spotlayout
            Widget:
                id: pawnlayout
    BoxLayout:
        id: timemenu
        pos_hint: {'bot': 0}
        size_hint: (0.85, 0.1)
        orientation: 'horizontal'
        ToggleButton:
            font_name: 'Symbola.ttf'
            font_size: 50
            text: chr(0x25b6)
        BoxLayout:
            orientation: 'vertical'
            Label:
                text: 'Step'
            BoxLayout:
                orientation: 'horizontal'
                Button:
                    text: 'Tick'
                    on_press: root.next_tick()
                Button:
                    text: 'Rule'
                    on_press: root.advance()
        BoxLayout:
            orientation: 'vertical'
            Label:
                text: 'Branch'
            MenuTextInput:
                setter: root.set_branch
                hint_text: root.branch
        BoxLayout:
            orientation: 'vertical'
            Label:
                text: 'Tick'
            MenuIntInput:
                setter: root.set_tick
                hint_text: str(root.tick)
    BoxLayout:
        id: charmenu
        orientation: 'vertical'
        size_hint_x: 0.15
        pos_hint: {'right': 1}
        Button:
            halign: "center"
            # click this to change the active character
            text: 'Character:\n' + root.app.config['ELiDE']['boardchar']
        Button:
            # opens a popover where you view the rules active on this
            # character now, and may click one to edit it
            text: "Rules"
        Button:
            # deletes whatever you've got selected
            text: "Delete"
        Button:
            # This doesn't interact with the time travel, it's
            # strictly a way to go back on erroneous inputs from this
            # same tick. As such it grays out when you change the time.
            text: "Undo"
        Button:
            # Should have orb.png in it and if you drag that elsewhere it creates a new place there
            id: placeaddbut
            Dummy:
                id: dummyplace
                center: placeaddbut.center
                prefix: 'place'
                paths: ['orb.png']
                on_pos_up: root.spot_from_dummy(self)
        ToggleButton:
            # While this is active, dragging between two spots creates a portal
            id: portaladdbut
            ArrowWidget:
                board: board
                origin: emptyleft
                destination: emptyright
                Widget:
                    id: emptyleft
                    center_x: portaladdbut.x + portaladdbut.width / 3
                    center_y: portaladdbut.center_y
                    size: (0, 0)
                Widget:
                    id: emptyright
                    center_x: portaladdbut.right - portaladdbut.width / 3
                    center_y: portaladdbut.center_y
                    size: (0, 0)
        Button:
            # Has the generic thing-graphic in it, drag it on top of a spot and you get a new thing
            id: thingaddbut
            Dummy:
                id: dummything
                center: thingaddbut.center
                prefix: 'thing'
                paths: ['atlas://rltiles/base.atlas/unseen']
                on_pos_up: root.pawn_from_dummy(self)